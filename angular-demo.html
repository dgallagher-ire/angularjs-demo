<!DOCTYPE html>
<html ng-app="s3RedShiftApp">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>S3-RedShift Loader</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.0/angular.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">
	angular.module('s3RedShiftApp', []).controller(
			's3RedShiftAppController',
			function($scope, $window) {
				var mydata = this;
				
				// filter
				mydata.filterText = null;
				mydata.clearFilter = function(){
					mydata.filterText = null;
					this.filterProcess();
				}
				
				mydata.filterProcess = function() {
					console.log('Filter:'+mydata.filterText);
					if(mydata.filterText == null || mydata.filterText == ''){
						mydata.filteredData = mydata.data;
						return;
					}
					mydata.filteredData = [];
					angular.forEach(mydata.data, function(row) {
						if (row.bucket.toUpperCase().includes(mydata.filterText.toUpperCase())){
							mydata.filteredData.push(row);
						} else if (row.redshift.toUpperCase().includes(mydata.filterText.toUpperCase())){
							mydata.filteredData.push(row);
						}
					});
				};
				
				// form data
				mydata.selectedBucket = null;
				mydata.buckets = ['dgallagher.surplus','dgallagher.files','dgallagher.lambda','dgallagher.store','dgallagher.glacier'];
				mydata.selectedRedshift = null;
				mydata.redshift = ['harvest.surplus','ds.backup','harvest.logs'];
				mydata.selectedStatus = null;
				mydata.status = ['No', 'Yes'];
				mydata.selectedFiles = null;
				mydata.selectedBatch = null;
				
				// form alert
				mydata.showAlert = false;
				mydata.alertMessage = null;
				
				mydata.closeAlert = function(){
					mydata.showAlert = false;
					mydata.alertMessage = null;
				}
				
				// form validation
				mydata.validateForm = function(){
					console.log('in validation');
					if(mydata.selectedBucket == null){
						mydata.alertMessage = 'Please select a bucket';
						mydata.showAlert = true;
						return false;
					}
					if(mydata.selectedStatus == null){
						mydata.alertMessage = 'Please select if live';
						mydata.showAlert = true;
						return false;
					}
					if(mydata.selectedFiles == null){
						mydata.alertMessage = 'Please select a number of file';
						mydata.showAlert = true;
						return false;
					}
					if(mydata.selectedBatch == null){
						mydata.alertMessage = 'Please select a batch size';
						mydata.showAlert = true;
						return false;
					}
					if(mydata.selectedRedshift == null){
						mydata.alertMessage = 'Please select a RedShift table';
						mydata.showAlert = true;
						return false;
					}
					return true;
				}
				
				// new record validation
				mydata.validateNew = function(){
					var result = true;
					angular.forEach(mydata.data, function(item){
						if(item.bucket == mydata.selectedBucket){
							mydata.alertMessage = 'Loader already exists for bucket: '+mydata.selectedBucket;
							mydata.showAlert = true;
							result = false;
						}
					});
					if(!result){
						return false;
					}
					angular.forEach(mydata.data, function(item){
						if(item.redshift == mydata.selectedRedshift){
							mydata.alertMessage = 'Loader already exists for RedShift: '+mydata.selectedRedshift;
							mydata.showAlert = true;
							result = false;
						}
					});
					if(!result){
						return false;
					}
					return true;
				}

				// table data
				mydata.header = ['Bucket', 'Live', 'Files', 'Batch', 'RedShift', ''];

				// table data
				mydata.data = [ {
					bucket : 'dgallagher.surplus',
					live : true,
					files : 10000,
					batch : 1000,
					redshift : 'harvest.surplus'
				}, {
					bucket : 'dgallagher.files',
					live : true,
					files : 10000,
					batch : 1000,
					redshift : 'ds.backup'
				}, {
					bucket : 'dgallagher.store',
					live : false,
					files : 250000,
					batch : 20000,
					redshift : 'harvest.logs'
				}, ];
				
				mydata.filteredData = mydata.data;
				
				// display selected table row, based on bucket name
				mydata.edit = function(bucketName){
					angular.forEach(mydata.data, function(item){
						if(item.bucket == bucketName){
							//console.log(bucketName);
							mydata.showAlert = false;
							mydata.selectedBucket = bucketName;
							mydata.selectedRedshift = item.redshift;
							if(item.live){
								mydata.selectedStatus = 'Yes';
							} else{
								mydata.selectedStatus = 'No';
							}
							mydata.selectedFiles = item.files;
							mydata.selectedBatch = item.batch;
						}
						
					});
				}
				
				// clear bucket
				mydata.clear = function(bucketName){
					mydata.showAlert = false;
					mydata.selectedBucket = null;
					mydata.selectedRedshift = null;
					mydata.selectedStatus = null;
					mydata.selectedFiles = null;
					mydata.selectedBatch = null;
				}
				
				mydata.update = function(){
					console.log('in update');
					if(!this.validateForm()){
						console.log('validation failed');
						return;
					}
				}
				
				mydata.addNew = function(){
					console.log('in update');
					if(!this.validateForm()){
						console.log('validation failed');
						return;
					}
					if(!this.validateNew()){
						console.log('validation failed dup');
						return;
					}
				}
				
				mydata.delete = function(){
					console.log('in update');
					if(!this.validateForm()){
						console.log('validation failed');
						return;
					}
				}
				
				
			});
</script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
	google.charts.load("current", {
		packages : [ "corechart" ]
	});
	google.charts.setOnLoadCallback(drawChart);
	function drawChart() {
		var data = google.visualization.arrayToDataTable([
				[ 'Task', 'Hours per Day' ], [ 'Work', 11 ], [ 'Eat', 2 ],
				[ 'Commute', 2 ], [ 'Watch TV', 2 ], [ 'Sleep', 7 ] ]);

		var options = {
			title : 'My Daily Activities',
			is3D : true,
		};

		//var chart = new google.visualization.PieChart(document
		//		.getElementById('piechart_3d'));
		//chart.draw(data, options);
	}
</script>
</head>
<body ng-controller="s3RedShiftAppController as mydata">
	<div class="container">
		<div>
			<h3 class="page-header">S3-RedShift Loader</h3>
		</div>
		<div class="form-group has-feedback input-group-sm">
			<input ng-model="mydata.filterText" ng-change="mydata.filterProcess()" type="search" class="form-control" aria-describedby="inputError2Status" placeholder="filter...">
			<span ng-click="mydata.clearFilter()" class="glyphicon glyphicon-remove form-control-feedback" style="pointer-events: initial; color: #31b0d5; cursor: pointer;"></span>
		</div>
		<div>
			<table class="table table-hover table-condensed">
				<thead>
					<tr class="info">
						<th ng-repeat="head in mydata.header">{{head}}</th>
					</tr>
				</thead>
				<tbody>
					<tr ng-repeat="row in mydata.filteredData">
						<td>{{row.bucket}}</td>
						<td ng-if="row.live == true"><span class="label label-success">Yes</span></td>
						<td ng-if="row.live == false"><span class="label label-danger">No</span></td>
						<td>{{row.files}}</td>
						<td>{{row.batch}}</td>
						<td>{{row.redshift}}</td>
						<td><a href="#myForm"><button type="button" ng-click="mydata.edit(row.bucket)" class="btn btn-info btn-xs">Edit</button></a></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div>
			<form id="myForm">
				<div class="alert alert-warning" ng-show="mydata.showAlert">
					<button type="button" class="close" data-ng-click="mydata.closeAlert()" >Ã—</button>
					<strong>{{mydata.alertMessage}}</strong>
				</div>
				<div class="form-group">
					<label for="exampleInputBucket">Bucket</label>
					<select class="form-control" id="exampleInputBucket" ng-model="mydata.selectedBucket" ng-options="opt as opt for opt in mydata.buckets">
						<option disabled selected></option>
					</select>
				</div>
				<div class="form-group">
					<label for="exampleInputBucket">Live</label>
					<select class="form-control" id="exampleInputBucket" ng-model="mydata.selectedStatus" ng-options="opt as opt for opt in mydata.status">
						<option disabled selected></option>
					</select>
				</div>
				<div class="form-group">
					<label for="exampleInputPassword1">Files</label>
					<input type="number" ng-model="mydata.selectedFiles" class="form-control" id="exampleInputPassword1" placeholder="Number 1 - 1,000,000">
				</div>
				<div class="form-group">
					<label for="exampleInputPassword1">Batch</label>
					<input type="number" ng-model="mydata.selectedBatch" class="form-control" id="exampleInputPassword1" placeholder="Number 1 - 1,000">
				</div>
				<div class="form-group">
					<label for="exampleInputBucket">RedShift</label> 
					<select class="form-control" id="exampleInputBucket" ng-model="mydata.selectedRedshift" ng-options="opt as opt for opt in mydata.redshift">
						<option disabled selected></option>
					</select>
				</div>
				<button type="submit" ng-click="mydata.update()" class="btn btn-info">Update</button>
				<button type="submit" ng-click="mydata.clear()" class="btn btn-warning">Clear</button>
				<button type="submit" ng-click="mydata.addNew()" class="btn btn-success">Add New</button>
				<button type="submit" ng-click="mydata.delete()" class="btn btn-danger">Delete</button>
			</form>
		</div>
		<!-- <div id="piechart_3d"></div>-->
		<div style="height: 60px">
		</div>
	</div>
</body>
</html>